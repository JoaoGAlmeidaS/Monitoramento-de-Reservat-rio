<!DOCTYPE html>
<html>
<head>
    <title>Monitor ESP</title>
    <style>
        body { font-family: Arial; }
        .box {
            font-size: 40px;
            padding: 20px;
            border: 2px solid #333;
            display: inline-block;
            margin-top: 40px;
        }
    </style>
</head>
<body>

<h1>Dados do ESP</h1>

<div class="box" id="temp">
    Clique em "Atualizar" para carregar o dado.
</div>

<br><br>

<button onclick="atualizar()" style="font-size: 20px;">Atualizar</button>

<br><br>

<h2>Histórico de Dados</h2>
<button onclick="carregarHistorico()" style="font-size: 20px;">Carregar Histórico</button>
<table id="history" border="1" style="width:100%; margin-top:20px;">
    <thead>
        <tr>
            <th>ID</th>
            <th>Dispositivo</th>
            <th>Volume</th>
            <th>Umidade</th>
            <th>Temperatura</th>
            <th>Profundidade</th>
            <th>Timestamp</th>
            <th>Mensagem Bruta</th>
            <th>Criado em</th>
        </tr>
    </thead>
    <tbody id="history-body">
        <!-- Dados serão inseridos aqui -->
    </tbody>
</table>

<script>
function atualizar() {

    console.log("Buscando no backend...");

    fetch("/monitor/", {
        method: "GET",
        cache: "no-store"  // força SEM CACHE
    })
    .then(res => res.json())
    .then(data => {

        console.log("Resposta recebida:", data);

        // Se houver erro, mostrar mensagem de erro
        if (data.error) {
            document.getElementById("temp").innerHTML = `
                <p style="font-size: 24px; color: red;">${data.error}</p>
            `;
            return;
        }

        // Se não houver mensagem bruta, avisar
        if (!data || !data.raw_message) {
            document.getElementById("temp").innerHTML = `
                <p style="font-size: 24px; color: red;">Nenhum dado recebido</p>
            `;
            return;
        }

        // Se os campos estiverem presentes, mostre cada um separadamente
        if (data.devid || data.volume || data.umidade || data.temperatura || data.profundidade || data.timestamp) {
            document.getElementById("temp").innerHTML = `
                <div style="font-size:20px; text-align:left;">
                    <div><strong>Dispositivo:</strong> ${data.devid ?? '-'} </div>
                    <div><strong>Volume:</strong> ${data.volume ?? '-'} </div>
                    <div><strong>Umidade:</strong> ${data.umidade ?? '-'} </div>
                    <div><strong>Temperatura:</strong> ${data.temperatura ?? '-'} </div>
                    <div><strong>Profundidade:</strong> ${data.profundidade ?? '-'} </div>
                    <div><strong>Timestamp:</strong> ${data.timestamp ?? '-'} </div>
                </div>
            `;
        } else {
            // Caso não seja JSON parseável em campos esperados, mostra a mensagem bruta
            document.getElementById("temp").innerHTML = `
                <p style="font-size: 24px; color: green;">${data.raw_message}</p>
            `;
        }
    })
    .catch(err => {
        console.error("Erro ao buscar:", err);
    });
}

function carregarHistorico() {
    console.log("Carregando histórico...");

    fetch("/monitor/data/", {
        method: "GET",
        cache: "no-store"
    })
    .then(res => res.json())
    .then(data => {
        console.log("Histórico recebido:", data);

        const tbody = document.getElementById("history-body");
        tbody.innerHTML = "";  // Limpar tabela

        data.forEach(item => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${item.id}</td>
                <td>${item.devid || '-'}</td>
                <td>${item.volume || '-'}</td>
                <td>${item.umidade || '-'}</td>
                <td>${item.temperatura || '-'}</td>
                <td>${item.profundidade || '-'}</td>
                <td>${item.timestamp || '-'}</td>
                <td>${item.raw_message || '-'}</td>
                <td>${item.created_at}</td>
            `;
            tbody.appendChild(row);
        });
    })
    .catch(err => {
        console.error("Erro ao carregar histórico:", err);
    });
}
</script>

</body>
</html>
